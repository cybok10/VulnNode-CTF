<%- include('partials/header') %>

<h1 class="text-info mb-4">
    <i class="fa-solid fa-ticket"></i> All Support Tickets
</h1>

<div class="row mb-3">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <select class="form-select d-inline-block me-2" id="filterStatus" style="width: 150px;">
                    <option value="">All Status</option>
                    <option value="open">Open</option>
                    <option value="pending">Pending</option>
                    <option value="closed">Closed</option>
                    <option value="resolved">Resolved</option>
                </select>
                <select class="form-select d-inline-block" id="filterPriority" style="width: 150px;">
                    <option value="">All Priority</option>
                    <option value="urgent">Urgent</option>
                    <option value="high">High</option>
                    <option value="normal">Normal</option>
                    <option value="low">Low</option>
                </select>
            </div>
            <a href="/admin" class="btn btn-outline-secondary">
                <i class="fa-solid fa-arrow-left"></i> Back to Admin
            </a>
        </div>
    </div>
</div>

<div class="card bg-dark border-info">
    <div class="card-body" id="ticketsContainer">
        <div class="text-center py-5">
            <div class="spinner-border text-info"></div>
            <p class="mt-3">Loading tickets...</p>
        </div>
    </div>
</div>

<script>
let allTickets = [];

function loadTickets() {
    fetch('/api/admin/tickets')
        .then(res => res.json())
        .then(data => {
            allTickets = data.tickets || [];
            displayTickets(allTickets);
        })
        .catch(err => {
            document.getElementById('ticketsContainer').innerHTML = `
                <div class="alert alert-danger">Failed to load tickets</div>
            `;
        });
}

function displayTickets(tickets) {
    const container = document.getElementById('ticketsContainer');
    
    if (!tickets || tickets.length === 0) {
        container.innerHTML = '<p class="text-center text-muted">No tickets found</p>';
        return;
    }
    
    let html = '<div class="table-responsive">';
    html += '<table class="table table-dark table-hover">';
    html += '<thead><tr><th>ID</th><th>User</th><th>Subject</th><th>Category</th><th>Priority</th><th>Status</th><th>Created</th><th>Actions</th></tr></thead>';
    html += '<tbody>';
    
    tickets.forEach(ticket => {
        const statusBadge = {
            'open': 'success',
            'pending': 'warning',
            'closed': 'secondary',
            'resolved': 'info'
        }[ticket.status] || 'secondary';
        
        const priorityBadge = {
            'low': 'info',
            'normal': 'primary',
            'high': 'warning',
            'urgent': 'danger'
        }[ticket.priority] || 'secondary';
        
        html += `
            <tr>
                <td>${ticket.id}</td>
                <td>${ticket.username || 'Unknown'}</td>
                <td>${ticket.subject}</td>
                <td><span class="badge bg-secondary">${ticket.category || 'N/A'}</span></td>
                <td><span class="badge bg-${priorityBadge}">${ticket.priority}</span></td>
                <td><span class="badge bg-${statusBadge}">${ticket.status}</span></td>
                <td>${new Date(ticket.created_at).toLocaleDateString()}</td>
                <td>
                    <a href="/support/${ticket.id}" class="btn btn-sm btn-outline-primary">
                        <i class="fa-solid fa-eye"></i> View
                    </a>
                    <button class="btn btn-sm btn-outline-success" onclick="closeTicket(${ticket.id})">
                        <i class="fa-solid fa-check"></i>
                    </button>
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
}

function closeTicket(id) {
    if (!confirm('Close this ticket?')) return;
    
    fetch(`/api/support/${id}/close`, {
        method: 'POST'
    })
    .then(res => res.json())
    .then(data => {
        if (data.message) {
            alert('Ticket closed');
            loadTickets();
        }
    });
}

// Filters
document.getElementById('filterStatus').addEventListener('change', applyFilters);
document.getElementById('filterPriority').addEventListener('change', applyFilters);

function applyFilters() {
    const status = document.getElementById('filterStatus').value;
    const priority = document.getElementById('filterPriority').value;
    
    let filtered = allTickets;
    
    if (status) {
        filtered = filtered.filter(t => t.status === status);
    }
    if (priority) {
        filtered = filtered.filter(t => t.priority === priority);
    }
    
    displayTickets(filtered);
}

document.addEventListener('DOMContentLoaded', loadTickets);
</script>

<%- include('partials/footer') %>