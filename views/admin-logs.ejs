<%- include('partials/header') %>

<h1 class="text-success mb-4">
    <i class="fa-solid fa-file-lines"></i> System Logs
</h1>

<div class="mb-3">
    <a href="/admin" class="btn btn-outline-secondary">
        <i class="fa-solid fa-arrow-left"></i> Back to Admin
    </a>
</div>

<!-- Log File Viewer (LFI Vulnerability) -->
<div class="card bg-dark border-success mb-4">
    <div class="card-header bg-success text-white">
        <h5 class="mb-0"><i class="fa-solid fa-folder-open"></i> View Log File</h5>
    </div>
    <div class="card-body">
        <form id="logForm" onsubmit="viewLog(event)">
            <div class="mb-3">
                <label class="form-label">Log File Path</label>
                <input type="text" class="form-control font-monospace" id="logPath" placeholder="/var/log/app.log" value="logs/app.log">
                <small class="text-muted">Try: logs/app.log, logs/error.log, ../../../etc/passwd</small>
            </div>
            <button type="submit" class="btn btn-success">
                <i class="fa-solid fa-eye"></i> View File
            </button>
        </form>
    </div>
</div>

<!-- Log Content -->
<div class="card bg-dark border-secondary">
    <div class="card-header">
        <h5 class="mb-0">Log Content</h5>
    </div>
    <div class="card-body">
        <pre id="logContent" class="bg-black text-light p-3 rounded" style="max-height: 600px; overflow-y: auto; white-space: pre-wrap;">Select a log file to view its contents...</pre>
    </div>
</div>

<!-- Recent Database Logs -->
<div class="card bg-dark border-info mt-4">
    <div class="card-header bg-info text-white">
        <h5 class="mb-0"><i class="fa-solid fa-database"></i> Recent Activity Logs</h5>
    </div>
    <div class="card-body" id="dbLogs">
        <div class="text-center py-3">
            <div class="spinner-border text-info"></div>
        </div>
    </div>
</div>

<script>
function viewLog(e) {
    e.preventDefault();
    
    const path = document.getElementById('logPath').value;
    
    // VULNERABILITY: Local File Inclusion (LFI)
    fetch('/api/admin/logs', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ file: path })
    })
    .then(res => res.json())
    .then(data => {
        if (data.content) {
            document.getElementById('logContent').textContent = data.content;
        } else {
            document.getElementById('logContent').textContent = 'Error: ' + (data.error || 'Failed to read file');
        }
    })
    .catch(err => {
        document.getElementById('logContent').textContent = 'Error: ' + err.message;
    });
}

function loadDatabaseLogs() {
    fetch('/api/admin/activity-logs')
        .then(res => res.json())
        .then(data => {
            const logs = data.logs || [];
            
            if (logs.length === 0) {
                document.getElementById('dbLogs').innerHTML = '<p class="text-muted">No logs found</p>';
                return;
            }
            
            let html = '<div class="table-responsive">';
            html += '<table class="table table-dark table-sm"><thead><tr><th>Type</th><th>Message</th><th>User</th><th>IP</th><th>Time</th></tr></thead><tbody>';
            
            logs.forEach(log => {
                const typeColor = {
                    'error': 'danger',
                    'warning': 'warning',
                    'login': 'info',
                    'admin': 'success',
                    'order': 'primary'
                }[log.log_type] || 'secondary';
                
                html += `
                    <tr>
                        <td><span class="badge bg-${typeColor}">${log.log_type}</span></td>
                        <td style="max-width: 400px; overflow: hidden; text-overflow: ellipsis;">${log.message}</td>
                        <td>${log.user_id || 'N/A'}</td>
                        <td>${log.ip_address || 'N/A'}</td>
                        <td><small>${new Date(log.created_at).toLocaleString()}</small></td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            document.getElementById('dbLogs').innerHTML = html;
        })
        .catch(() => {
            document.getElementById('dbLogs').innerHTML = '<p class="text-danger">Failed to load logs</p>';
        });
}

document.addEventListener('DOMContentLoaded', loadDatabaseLogs);
</script>

<%- include('partials/footer') %>