<%- include('partials/header') %>

<h1 class="text-warning mb-4">
    <i class="fa-solid fa-users"></i> User Management
</h1>

<div class="row mb-3">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <input type="text" class="form-control" id="searchUser" placeholder="Search users..." style="width: 300px;">
            </div>
            <a href="/admin" class="btn btn-outline-secondary">
                <i class="fa-solid fa-arrow-left"></i> Back to Admin
            </a>
        </div>
    </div>
</div>

<div class="card bg-dark border-warning">
    <div class="card-body" id="usersContainer">
        <div class="text-center py-5">
            <div class="spinner-border text-warning"></div>
            <p class="mt-3">Loading users...</p>
        </div>
    </div>
</div>

<script>
let allUsers = [];

function loadUsers() {
    fetch('/api/admin/users')
        .then(res => res.json())
        .then(data => {
            allUsers = data.users || [];
            displayUsers(allUsers);
        })
        .catch(err => {
            document.getElementById('usersContainer').innerHTML = `
                <div class="alert alert-danger">Failed to load users</div>
            `;
        });
}

function displayUsers(users) {
    const container = document.getElementById('usersContainer');
    
    if (!users || users.length === 0) {
        container.innerHTML = '<p class="text-center text-muted">No users found</p>';
        return;
    }
    
    let html = '<div class="table-responsive">';
    html += '<table class="table table-dark table-hover">';
    html += '<thead><tr><th>ID</th><th>Username</th><th>Email</th><th>Role</th><th>Balance</th><th>Status</th><th>Actions</th></tr></thead>';
    html += '<tbody>';
    
    users.forEach(user => {
        const role = user.isAdmin ? '<span class="badge bg-warning">Admin</span>' : 
                     user.isVendor ? '<span class="badge bg-info">Vendor</span>' : 
                     '<span class="badge bg-secondary">User</span>';
        
        html += `
            <tr>
                <td>${user.id}</td>
                <td>
                    <div class="d-flex align-items-center">
                        <img src="${user.avatar || '/img/avatars/default.png'}" width="30" class="rounded-circle me-2" onerror="this.src='/img/avatars/default.png'">
                        <strong>${user.username}</strong>
                    </div>
                </td>
                <td>${user.email}</td>
                <td>${role}</td>
                <td>$${user.balance.toFixed(2)}</td>
                <td><span class="badge bg-${user.account_status === 'active' ? 'success' : 'danger'}">${user.account_status}</span></td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="viewUser(${user.id})">
                        <i class="fa-solid fa-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-warning" onclick="editUser(${user.id})">
                        <i class="fa-solid fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteUser(${user.id}, '${user.username}')">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
}

function viewUser(id) {
    window.location.href = `/admin/users/${id}`;
}

function editUser(id) {
    alert('Edit user feature - Coming soon!');
}

function deleteUser(id, username) {
    if (!confirm(`Delete user "${username}"?`)) return;
    
    fetch(`/api/admin/users/${id}`, {
        method: 'DELETE'
    })
    .then(res => res.json())
    .then(data => {
        if (data.message) {
            alert('User deleted');
            loadUsers();
        } else {
            alert('Error: ' + (data.error || 'Failed to delete user'));
        }
    });
}

// Search functionality
document.getElementById('searchUser').addEventListener('input', (e) => {
    const query = e.target.value.toLowerCase();
    const filtered = allUsers.filter(u => 
        u.username.toLowerCase().includes(query) || 
        u.email.toLowerCase().includes(query)
    );
    displayUsers(filtered);
});

document.addEventListener('DOMContentLoaded', loadUsers);
</script>

<%- include('partials/footer') %>