<%- include('partials/header') %>

<h1 class="text-success mb-4">
    <i class="fa-solid fa-credit-card"></i> Checkout
</h1>

<div class="row">
    <div class="col-lg-8">
        <!-- Shipping Address -->
        <div class="card bg-dark border-secondary mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fa-solid fa-truck"></i> Shipping Address</h5>
            </div>
            <div class="card-body">
                <form id="addressForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Full Name *</label>
                            <input type="text" class="form-control" id="fullName" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Phone *</label>
                            <input type="tel" class="form-control" id="phone" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Address Line 1 *</label>
                        <input type="text" class="form-control" id="address1" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Address Line 2</label>
                        <input type="text" class="form-control" id="address2">
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">City *</label>
                            <input type="text" class="form-control" id="city" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">State *</label>
                            <input type="text" class="form-control" id="state" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">ZIP Code *</label>
                            <input type="text" class="form-control" id="zip" required>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Payment Method -->
        <div class="card bg-dark border-secondary">
            <div class="card-header">
                <h5 class="mb-0"><i class="fa-solid fa-credit-card"></i> Payment Method</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <select class="form-select" id="paymentMethod">
                        <option value="credit_card">Credit Card</option>
                        <option value="debit_card">Debit Card</option>
                        <option value="paypal">PayPal</option>
                        <option value="crypto">Cryptocurrency</option>
                    </select>
                </div>
                <div id="cardDetails">
                    <div class="mb-3">
                        <label class="form-label">Card Number</label>
                        <input type="text" class="form-control" id="cardNumber" placeholder="1234 5678 9012 3456">
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Expiry Date</label>
                            <input type="text" class="form-control" id="cardExpiry" placeholder="MM/YY">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">CVV</label>
                            <input type="text" class="form-control" id="cardCVV" placeholder="123">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Order Summary -->
    <div class="col-lg-4">
        <div class="card bg-dark border-success sticky-top" style="top: 20px;">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">Order Summary</h5>
            </div>
            <div class="card-body" id="orderSummary">
                <div class="text-center py-3">
                    <div class="spinner-border text-success"></div>
                </div>
            </div>
            <div class="card-footer">
                <div class="d-grid">
                    <button class="btn btn-success btn-lg" onclick="placeOrder()">
                        <i class="fa-solid fa-lock"></i> Place Order
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let cartData = {};

function loadCheckoutData() {
    fetch('/api/cart')
        .then(res => res.json())
        .then(data => {
            cartData = data;
            displayOrderSummary(data);
        });
}

function displayOrderSummary(data) {
    document.getElementById('orderSummary').innerHTML = `
        <div class="d-flex justify-content-between mb-2">
            <span>Items (${data.items ? data.items.length : 0}):</span>
            <span>$${(data.subtotal || 0).toFixed(2)}</span>
        </div>
        <div class="d-flex justify-content-between mb-2 text-success">
            <span>Discount:</span>
            <span>-$${(data.discount || 0).toFixed(2)}</span>
        </div>
        <div class="d-flex justify-content-between mb-2">
            <span>Shipping:</span>
            <span>$${(data.shipping || 0).toFixed(2)}</span>
        </div>
        <div class="d-flex justify-content-between mb-2">
            <span>Tax:</span>
            <span>$${(data.tax || 0).toFixed(2)}</span>
        </div>
        <hr class="border-secondary">
        <div class="d-flex justify-content-between h4 text-success">
            <strong>Total:</strong>
            <strong>$${(data.total || 0).toFixed(2)}</strong>
        </div>
    `;
}

function placeOrder() {
    const orderData = {
        shipping_address: {
            full_name: document.getElementById('fullName').value,
            phone: document.getElementById('phone').value,
            address_line1: document.getElementById('address1').value,
            address_line2: document.getElementById('address2').value,
            city: document.getElementById('city').value,
            state: document.getElementById('state').value,
            postal_code: document.getElementById('zip').value,
            country: 'USA'
        },
        payment_method: document.getElementById('paymentMethod').value,
        payment_details: {
            card_number: document.getElementById('cardNumber').value,
            expiry: document.getElementById('cardExpiry').value,
            cvv: document.getElementById('cardCVV').value
        }
    };
    
    fetch('/api/checkout/place-order', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(orderData)
    })
    .then(res => res.json())
    .then(data => {
        if (data.order_number) {
            window.location.href = `/checkout/confirmation/${data.order_number}`;
        } else {
            alert('Error: ' + (data.error || 'Failed to place order'));
        }
    });
}

document.addEventListener('DOMContentLoaded', loadCheckoutData);
</script>

<%- include('partials/footer') %>